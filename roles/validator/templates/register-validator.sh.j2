#!/bin/bash
# Register Monad Validator
# Generated by Ansible
#
# This script prompts for keys at runtime for security.
# Keys are NOT stored in this file.

set -e

STAKING_CLI_DIR="{{ monad_home }}/staking-sdk-cli"
CONFIG_FILE="${STAKING_CLI_DIR}/config.toml"
STAKE_AMOUNT="{{ validator_stake_amount }}"
AUTH_ADDRESS="{{ auth_address }}"

echo "============================================"
echo "Monad Validator Registration"
echo "============================================"
echo ""
echo "Stake Amount: ${STAKE_AMOUNT} MON"
echo "Auth Address: ${AUTH_ADDRESS}"
echo ""
echo "You will need:"
echo "  - SECP private key (64 hex chars, no 0x prefix)"
echo "  - BLS private key (with 0x prefix)"
echo ""

# Check if node is synced
echo "Checking node sync status..."
SYNC_STATUS=$(curl -s -X POST "http://localhost:{{ monad_rpc_port }}" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_syncing","id":1}' | jq -r '.result')

if [ "$SYNC_STATUS" != "false" ]; then
  echo "ERROR: Node is still syncing. Wait for sync to complete."
  exit 1
fi
echo "Node is synced"
echo ""

# Prompt for keys (secure - not echoed)
read -s -p "Enter SECP private key: " SECP_KEY
echo ""

# Validate SECP key format
if [ ${#SECP_KEY} -ne 64 ]; then
  echo "ERROR: SECP key must be 64 hex characters (without 0x prefix)"
  exit 1
fi

read -s -p "Enter BLS private key (with 0x prefix): " BLS_KEY
echo ""

# Validate BLS key format
if [ ${#BLS_KEY} -ne 66 ] || [[ ! "$BLS_KEY" =~ ^0x ]]; then
  echo "ERROR: BLS key must be 66 characters (0x + 64 hex chars)"
  exit 1
fi

echo ""
echo "============================================"
echo "WARNING: This will stake ${STAKE_AMOUNT} MON"
echo "============================================"
echo ""
read -p "Type 'yes' to confirm registration: " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
  echo "Aborted."
  exit 1
fi

# Activate virtualenv and run registration
source "${STAKING_CLI_DIR}/cli-venv/bin/activate"
cd "${STAKING_CLI_DIR}"

echo ""
echo "Registering validator..."
python staking-cli/main.py add-validator \
  --secp-privkey "${SECP_KEY}" \
  --bls-privkey "${BLS_KEY}" \
  --auth-address "${AUTH_ADDRESS}" \
  --amount ${STAKE_AMOUNT} \
  --config-path config.toml

RESULT=$?

# Clear sensitive variables
unset SECP_KEY
unset BLS_KEY

if [ $RESULT -eq 0 ]; then
  echo ""
  echo "============================================"
  echo "Validator registration submitted!"
  echo "============================================"
  echo ""
  echo "Check status with: ~/scripts/check-validator-status.sh"
  echo ""
  echo "Your validator will become active in the next epoch if:"
  echo "  1. Self-stake >= 100,000 MON"
  echo "  2. Total stake >= 10,000,000 MON"
  echo "  3. In top 200 validators by stake weight"
else
  echo ""
  echo "Registration failed. Check the error above."
  exit 1
fi
