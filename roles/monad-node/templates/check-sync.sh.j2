#!/bin/bash
# Check Monad node sync status
# Generated by Ansible

set -e

RPC_URL="http://localhost:{{ monad_rpc_port }}"

echo "Checking Monad node sync status..."

# Get chain ID
CHAIN_ID=$(curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_chainId","id":1}' | jq -r '.result')

# Get latest block
BLOCK_NUMBER=$(curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_blockNumber","id":1}' | jq -r '.result')

# Get syncing status
SYNCING=$(curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_syncing","id":1}' | jq -r '.result')

echo "================================"
echo "Chain ID: $CHAIN_ID ($(printf '%d' $CHAIN_ID))"
echo "Latest Block: $BLOCK_NUMBER ($(printf '%d' $BLOCK_NUMBER))"
echo "Syncing: $SYNCING"
echo "================================"

if [ "$SYNCING" == "false" ]; then
  echo "Node is fully synced!"
  exit 0
else
  echo "‚è≥ Node is still syncing..."
  exit 1
fi
