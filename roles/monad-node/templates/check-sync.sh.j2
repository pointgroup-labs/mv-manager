#!/bin/bash
# Check Monad node sync status

RPC_URL="http://localhost:{{ monad_rpc_port }}"

echo "Checking Monad node sync status..."
echo "================================"

# Check if RPC is responding
if ! curl -s --connect-timeout 5 -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_chainId","id":1}' > /dev/null 2>&1; then
  echo "RPC not responding at $RPC_URL"
  echo "Node may still be starting up..."
  echo "================================"
  exit 1
fi

# Get chain ID
CHAIN_RESULT=$(curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_chainId","id":1}')
CHAIN_ID=$(echo "$CHAIN_RESULT" | jq -r '.result // empty')

# Get latest block
BLOCK_RESULT=$(curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_blockNumber","id":1}')
BLOCK_NUMBER=$(echo "$BLOCK_RESULT" | jq -r '.result // empty')

# Get syncing status
SYNC_RESULT=$(curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_syncing","id":1}')
SYNCING=$(echo "$SYNC_RESULT" | jq -r '.result')

if [ -n "$CHAIN_ID" ]; then
  echo "Chain ID: $CHAIN_ID ($(printf '%d' "$CHAIN_ID" 2>/dev/null || echo 'N/A'))"
else
  echo "Chain ID: N/A"
fi

if [ -n "$BLOCK_NUMBER" ]; then
  echo "Latest Block: $BLOCK_NUMBER ($(printf '%d' "$BLOCK_NUMBER" 2>/dev/null || echo 'N/A'))"
else
  echo "Latest Block: N/A"
fi

echo "Syncing: $SYNCING"
echo "================================"

if [ "$SYNCING" == "false" ]; then
  echo "Node is fully synced!"
  exit 0
else
  echo "Node is still syncing..."
  exit 1
fi
