#!/bin/bash
# Cleanup old Monad backups
# Generated by Ansible

set -e

BACKUP_DIR="{{ backup_destination }}"
RETENTION_DAYS={{ backup_retention_days }}
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$TIMESTAMP] Cleaning up backups older than ${RETENTION_DAYS} days..."

# Count before cleanup
BEFORE_COUNT=$(find "${BACKUP_DIR}/config" -name "*.tar.gz" -type f 2>/dev/null | wc -l)

# Remove old config backups
find "${BACKUP_DIR}/config" -name "*.tar.gz" -type f -mtime +${RETENTION_DAYS} -delete 2>/dev/null || true

# Count after cleanup
AFTER_COUNT=$(find "${BACKUP_DIR}/config" -name "*.tar.gz" -type f 2>/dev/null | wc -l)
DELETED=$((BEFORE_COUNT - AFTER_COUNT))

echo "[$TIMESTAMP] Cleanup complete: removed $DELETED old backups, $AFTER_COUNT remaining"
