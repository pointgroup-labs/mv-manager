#!/bin/bash
# Monad Validator Backup Script
# Generated by Ansible

set -e

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="{{ backup_destination }}"
CONFIG_BACKUP="${BACKUP_DIR}/config/monad-config-${TIMESTAMP}.tar.gz"

echo "[$TIMESTAMP] Starting Monad backup..."

# Backup configuration files
echo "Backing up configuration..."
tar -czf "$CONFIG_BACKUP" \
  -C {{ monad_home }} \
  --exclude='*.log' \
  --exclude='backups' \
  monad-bft/config \
  .env \
  staking-sdk-cli/config.toml 2>/dev/null || true

if [ -f "$CONFIG_BACKUP" ]; then
  echo "Config backup created: $CONFIG_BACKUP"
  ls -lh "$CONFIG_BACKUP"
else
  echo "Config backup failed"
  exit 1
fi

{% if backup_remote_enabled | default(false) %}
# Upload to S3 (if configured)
echo "Uploading to S3..."
aws s3 cp "$CONFIG_BACKUP" "s3://{{ backup_s3_bucket }}/monad-validator/config/" \
  --region {{ backup_s3_region }}
echo "Uploaded to S3"
{% endif %}

echo "[$TIMESTAMP] Backup completed successfully!"
