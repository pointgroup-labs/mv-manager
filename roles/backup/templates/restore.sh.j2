#!/bin/bash
# Monad Validator Restore Script
# Generated by Ansible

set -e

BACKUP_DIR="{{ backup_destination }}"

echo "============================================"
echo "Monad Validator Restore"
echo "============================================"
echo ""

# List available backups
echo "Available config backups:"
ls -lt "${BACKUP_DIR}/config/" | head -10
echo ""

read -p "Enter backup filename to restore (or 'latest'): " BACKUP_FILE

if [ "$BACKUP_FILE" == "latest" ]; then
  BACKUP_FILE=$(ls -t "${BACKUP_DIR}/config/" | head -1)
fi

RESTORE_PATH="${BACKUP_DIR}/config/${BACKUP_FILE}"

if [ ! -f "$RESTORE_PATH" ]; then
  echo "Backup file not found: $RESTORE_PATH"
  exit 1
fi

echo ""
echo "Will restore from: $RESTORE_PATH"
read -p "This will overwrite current config. Continue? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
  echo "Aborted."
  exit 1
fi

# Stop the node
echo "Stopping Monad node..."
cd {{ monad_home }}/monad-bft/docker/single-node
docker compose down

# Restore configuration
echo "Restoring configuration..."
tar -xzf "$RESTORE_PATH" -C {{ monad_home }}

# Restart the node
echo "Starting Monad node..."
docker compose up -d

echo ""
echo "Restore completed!"
echo "Check node status with: {{ monad_home }}/scripts/check-sync.sh"
