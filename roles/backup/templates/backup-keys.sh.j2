#!/bin/bash
# Monad Validator Key Backup Script (Encrypted)
# Generated by Ansible
# WARNING: Handle backup files with extreme care!

set -e

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="{{ backup_destination }}/keys"
KEY_BACKUP="${BACKUP_DIR}/monad-keys-${TIMESTAMP}.tar.gz.enc"
TEMP_TAR="/tmp/monad-keys-${TIMESTAMP}.tar.gz"

echo "============================================"
echo "Monad Validator Key Backup (Encrypted)"
echo "============================================"
echo ""
echo "WARNING: Keep the backup password secure!"
echo "Losing the password means losing access to keys!"
echo ""

# Check if keys exist
if [ ! -d "{{ monad_config_dir }}/id-secp" ] || [ ! -d "{{ monad_config_dir }}/id-bls" ]; then
  echo "Key directories not found. Has the node been initialized?"
  exit 1
fi

# Create tarball of keys
echo "Creating key archive..."
tar -czf "$TEMP_TAR" \
  -C {{ monad_config_dir }} \
  id-secp \
  id-bls

# Encrypt with openssl
echo ""
read -s -p "Enter encryption password: " PASSWORD
echo ""
read -s -p "Confirm password: " PASSWORD_CONFIRM
echo ""

if [ "$PASSWORD" != "$PASSWORD_CONFIRM" ]; then
  echo "Passwords do not match!"
  rm -f "$TEMP_TAR"
  exit 1
fi

openssl enc -aes-256-cbc -salt -pbkdf2 \
  -in "$TEMP_TAR" \
  -out "$KEY_BACKUP" \
  -pass pass:"$PASSWORD"

# Secure cleanup
rm -f "$TEMP_TAR"

# Set restrictive permissions
chmod 600 "$KEY_BACKUP"

echo ""
echo "Encrypted key backup created: $KEY_BACKUP"
echo ""
echo "To restore, use:"
echo "  openssl enc -aes-256-cbc -d -pbkdf2 -in $KEY_BACKUP | tar -xzf - -C {{ monad_config_dir }}"
echo ""
echo "IMPORTANT: Store this backup securely offline!"
