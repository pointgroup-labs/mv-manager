#!/bin/bash
# Alert Script - Send notifications
# Generated by Ansible
# Configure your alerting channels in vault.yml

TITLE="$1"
MESSAGE="$2"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
HOSTNAME=$(hostname)

# Log the alert
echo "[$TIMESTAMP] ALERT: $TITLE - $MESSAGE" >> {{ monad_logs_dir }}/alerts.log

# Slack notification (if configured)
{% if vault_slack_webhook_url is defined and vault_slack_webhook_url != "" %}
curl -s -X POST "{{ vault_slack_webhook_url }}" \
  -H "Content-Type: application/json" \
  -d "{
    \"text\": \"ðŸš¨ *$TITLE*\",
    \"attachments\": [{
      \"color\": \"danger\",
      \"fields\": [
        {\"title\": \"Host\", \"value\": \"$HOSTNAME\", \"short\": true},
        {\"title\": \"Time\", \"value\": \"$TIMESTAMP\", \"short\": true},
        {\"title\": \"Details\", \"value\": \"$MESSAGE\"}
      ]
    }]
  }" > /dev/null 2>&1
{% endif %}

# Telegram notification (if configured)
{% if vault_telegram_bot_token is defined and vault_telegram_bot_token != "" %}
curl -s -X POST "https://api.telegram.org/bot{{ vault_telegram_bot_token }}/sendMessage" \
  -d "chat_id={{ vault_telegram_chat_id }}" \
  -d "text=ðŸš¨ *$TITLE*%0A%0AHost: $HOSTNAME%0ATime: $TIMESTAMP%0A%0A$MESSAGE" \
  -d "parse_mode=Markdown" > /dev/null 2>&1
{% endif %}

# PagerDuty (if configured)
{% if vault_pagerduty_api_key is defined and vault_pagerduty_api_key != "" %}
curl -s -X POST "https://events.pagerduty.com/v2/enqueue" \
  -H "Content-Type: application/json" \
  -d "{
    \"routing_key\": \"{{ vault_pagerduty_api_key }}\",
    \"event_action\": \"trigger\",
    \"payload\": {
      \"summary\": \"$TITLE: $MESSAGE\",
      \"source\": \"$HOSTNAME\",
      \"severity\": \"critical\"
    }
  }" > /dev/null 2>&1
{% endif %}

echo "Alert sent: $TITLE"
