#!/bin/bash
# Monad Node Health Check
# Generated by Ansible

set -e

RPC_URL="http://localhost:{{ monad_rpc_port }}"
ALERT_SCRIPT="{{ monad_home }}/scripts/alert.sh"

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
ERRORS=()

echo "[$TIMESTAMP] Running health check..."

# Check 1: RPC availability
if ! curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_chainId","id":1}' > /dev/null 2>&1; then
  ERRORS+=("RPC endpoint not responding")
fi

# Check 2: Docker containers running
CONTAINERS=$(docker ps --filter "name=single-node" --format "{{ '{{' }}.Names{{ '}}' }}" | wc -l)
if [ "$CONTAINERS" -lt 3 ]; then
  ERRORS+=("Expected 3 containers, found $CONTAINERS")
fi

# Check 3: Disk usage
DISK_USAGE=$(df -h {{ monad_data_dir }} | awk 'NR==2 {print $5}' | tr -d '%')
if [ "$DISK_USAGE" -gt "{{ alert_disk_usage_percent }}" ]; then
  ERRORS+=("Disk usage at ${DISK_USAGE}%")
fi

# Check 4: Memory usage
MEM_USAGE=$(free | awk '/Mem:/ {printf "%.0f", $3/$2 * 100}')
if [ "$MEM_USAGE" -gt "{{ alert_memory_usage_percent }}" ]; then
  ERRORS+=("Memory usage at ${MEM_USAGE}%")
fi

# Check 5: Sync status (only alert if been running for a while)
SYNCING=$(curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_syncing","id":1}' 2>/dev/null | jq -r '.result')

# Report results
if [ ${#ERRORS[@]} -eq 0 ]; then
  echo "[$TIMESTAMP] All health checks passed"
  echo "  - RPC: OK"
  echo "  - Containers: $CONTAINERS running"
  echo "  - Disk: ${DISK_USAGE}%"
  echo "  - Memory: ${MEM_USAGE}%"
  echo "  - Syncing: $SYNCING"
else
  echo "[$TIMESTAMP] Health check failures:"
  for error in "${ERRORS[@]}"; do
    echo "  - $error"
  done

  # Send alert
  if [ -x "$ALERT_SCRIPT" ]; then
    $ALERT_SCRIPT "Monad Health Check Failed" "$(printf '%s\n' "${ERRORS[@]}")"
  fi

  exit 1
fi
