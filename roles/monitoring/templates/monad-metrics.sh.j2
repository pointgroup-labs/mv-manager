#!/bin/bash
# Monad Node Metrics Collector
# Generated by Ansible

set -e

RPC_URL="http://localhost:{{ monad_rpc_port }}"
METRICS_FILE="{{ monad_logs_dir }}/metrics.prom"

# Get block number
BLOCK_HEX=$(curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_blockNumber","id":1}' | jq -r '.result')
BLOCK_NUMBER=$((BLOCK_HEX))

# Get sync status
SYNCING=$(curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_syncing","id":1}' | jq -r '.result')

if [ "$SYNCING" == "false" ]; then
  SYNC_STATUS=1
else
  SYNC_STATUS=0
fi

# Get peer count
PEER_HEX=$(curl -s -X POST "$RPC_URL" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"net_peerCount","id":1}' | jq -r '.result' 2>/dev/null || echo "0x0")
PEER_COUNT=$((PEER_HEX))

# Write Prometheus metrics
cat > "$METRICS_FILE" << EOF
# HELP monad_block_number Current block number
# TYPE monad_block_number gauge
monad_block_number ${BLOCK_NUMBER}

# HELP monad_sync_status Sync status (1=synced, 0=syncing)
# TYPE monad_sync_status gauge
monad_sync_status ${SYNC_STATUS}

# HELP monad_peer_count Number of connected peers
# TYPE monad_peer_count gauge
monad_peer_count ${PEER_COUNT}

# HELP monad_up Node up status
# TYPE monad_up gauge
monad_up 1
EOF

echo "Metrics updated: block=$BLOCK_NUMBER synced=$SYNC_STATUS peers=$PEER_COUNT"
